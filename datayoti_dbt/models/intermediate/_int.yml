models:
  - name: int_sites_scd2
    description: "Modèle intermédiaire implémentant SCD2 (Slowly Changing Dimension Type 2) pour les sites basé sur les snapshots dbt."
    columns:
      - name: site_sk
        description: "Clé surrogate unique pour la dimension site dans le DWH (générée automatiquement par le snapshot dbt)."
        tests:
          - not_null
          - unique
      - name: site_source_id
        description: "Identifiant technique unique du site, provenant de la source brute."
        tests:
          - not_null
      - name: site_ref
        description: "Référence métier du site (code court)."
        tests:
          - not_null
      - name: site_name
        description: "Nom du site."
      - name: site_description
        description: "Description détaillée du site."
      - name: valid_from_ts
        description: "Indicateur SCD2: Horodatage indiquant à partir de quand cet enregistrement est valide (généré par le snapshot dbt)."
        tests:
          - not_null
      - name: valid_to_ts
        description: "Indicateur SCD2: Horodatage indiquant jusqu'à quand cet enregistrement est valide (NULL pour l'enregistrement actuel, généré par le snapshot dbt)."
      - name: is_current
        description: "Indicateur SCD2: Vrai si cet enregistrement est le plus récent pour ce site (calculé à partir de valid_to_ts)."
        tests:
          - not_null

  - name: int_devices
    description: "Modèle intermédiaire pour les appareils avec des informations nettoyées et enrichies. Filtre les devices qui ont un site_ref valide dans stg_sites."
    columns:
      - name: device_source_id
        description: "Identifiant technique unique de l'appareil, issu de la source brute."
        tests:
          - not_null
          - unique
      - name: device_mac_addr
        description: "Adresse MAC de l'appareil. Correspond à l'identifiant métier utilisé."
        tests:
          - not_null
          - unique
          - valid_mac_address
      - name: site_source_id
        description: "Identifiant technique du site auquel l'appareil est associé, provenant de la source brute. Ne peut pas être NULL car le modèle filtre les devices sans site valide."
        tests:
          - not_null
      - name: created_ts
        description: "Horodatage de création de l'appareil dans le système."
        tests:
          - not_null
      - name: updated_ts
        description: "Horodatage de dernière mise à jour de l'appareil."
        tests:
          - not_null

  - name: int_devices_scd2
    description: "Modèle intermédiaire implémentant SCD2 (Slowly Changing Dimension Type 2) pour les appareils basé sur les snapshots dbt."
    columns:
      - name: device_sk
        description: "Clé surrogate unique pour la dimension device dans le DWH (générée automatiquement par le snapshot dbt)."
        tests:
          - not_null
          - unique
      - name: device_source_id
        description: "Identifiant technique unique de l'appareil, provenant de la source brute."
        tests:
          - not_null
      - name: device_mac_addr
        description: "Adresse MAC de l'appareil. Correspond à l'identifiant métier utilisé."
        tests:
          - not_null
          - valid_mac_address
      - name: site_source_id
        description: "Identifiant technique du site auquel l'appareil est associé, provenant de la source brute."
        tests:
          - not_null
      - name: valid_from_ts
        description: "Indicateur SCD2: Horodatage indiquant à partir de quand cet enregistrement est valide (généré par le snapshot dbt)."
        tests:
          - not_null
      - name: valid_to_ts
        description: "Indicateur SCD2: Horodatage indiquant jusqu'à quand cet enregistrement est valide (NULL pour l'enregistrement actuel, généré par le snapshot dbt)."
      - name: is_current
        description: "Indicateur SCD2: Vrai si cet enregistrement est le plus récent pour cet appareil (calculé à partir de valid_to_ts)."
        tests:
          - not_null

  - name: int_daily_sensor_reading
    description: "Modèle intermédiaire pour les lectures de capteurs (température et humidité) agrégées par jour. Utilise des jointures temporelles SCD2 avec les dimensions devices et sites."
    columns:
      - name: device_sk
        description: "Clé surrogate de l'appareil (référence vers dim_devices)."
        tests:
          - not_null
      - name: site_sk
        description: "Clé surrogate du site (référence vers dim_sites)."
        tests:
          - not_null
      - name: event_day_sk
        description: "Date de l'événement tronquée au jour."
        tests:
          - not_null
      - name: avg_temperature_celsius
        description: "Température moyenne en degrés Celsius pour la journée."
      - name: min_temperature_celsius
        description: "Température minimale en degrés Celsius pour la journée."
      - name: max_temperature_celsius
        description: "Température maximale en degrés Celsius pour la journée."
      - name: avg_humidity_percentage
        description: "Humidité moyenne en pourcentage pour la journée."
      - name: min_humidity_percentage
        description: "Humidité minimale en pourcentage pour la journée."
      - name: max_humidity_percentage
        description: "Humidité maximale en pourcentage pour la journée."
      - name: total_readings
        description: "Nombre total de lectures de capteurs pour la journée."
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - device_sk
            - site_sk
            - event_day_sk

  - name: int_daily_sensor_health
    description: "Modèle intermédiaire pour les métriques de santé des appareils agrégées par jour. Utilise des jointures temporelles SCD2 avec les dimensions devices et sites."
    columns:
      - name: device_sk
        description: "Clé surrogate de l'appareil (référence vers dim_devices)."
        tests:
          - not_null
      - name: site_sk
        description: "Clé surrogate du site (référence vers dim_sites)."
        tests:
          - not_null
      - name: event_day_sk
        description: "Date de l'événement tronquée au jour pour l'agrégation."
        tests:
          - not_null
      - name: avg_rssi_dbm
        description: "Moyenne du signal RSSI en dBm pour la journée."
      - name: min_rssi_dbm
        description: "Valeur minimale du signal RSSI en dBm pour la journée."
      - name: max_rssi_dbm
        description: "Valeur maximale du signal RSSI en dBm pour la journée."
      - name: avg_free_heap_bytes
        description: "Moyenne de la mémoire heap libre en octets pour la journée."
      - name: min_free_heap_bytes
        description: "Valeur minimale de la mémoire heap libre en octets pour la journée."
      - name: max_free_heap_bytes
        description: "Valeur maximale de la mémoire heap libre en octets pour la journée."
      - name: avg_min_heap_bytes
        description: "Moyenne du minimum de mémoire heap atteint en octets pour la journée."
      - name: min_min_heap_bytes
        description: "Valeur minimale du minimum de mémoire heap atteint en octets pour la journée."
      - name: max_min_heap_bytes
        description: "Valeur maximale du minimum de mémoire heap atteint en octets pour la journée."
      - name: avg_uptime_secs
        description: "Moyenne du temps de fonctionnement en secondes pour la journée."
      - name: min_uptime_secs
        description: "Valeur minimale du temps de fonctionnement en secondes pour la journée."
      - name: max_uptime_secs
        description: "Valeur maximale du temps de fonctionnement en secondes pour la journée."
      - name: ntp_sync_count
        description: "Nombre de heartbeats avec synchronisation NTP active pour la journée."
      - name: total_heartbeats
        description: "Nombre total de heartbeats reçus pour la journée."
        tests:
          - not_null
      - name: heartbeat_coverage_percentage
        description: "Pourcentage de couverture des heartbeats reçus par rapport au nombre attendu pour la journée."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - device_sk
            - site_sk
            - event_day_sk

  - name: int_conformity_rules
    description: "Modèle intermédiaire pour les règles de conformité avec enrichissement par jointure avec les sites. Filtre les règles qui ont un site_ref valide dans la dimension des sites."
    columns:
      - name: rule_id
        description: "Identifiant technique unique de la règle de conformité, provenant de la source brute."
        tests:
          - not_null
          - unique
      - name: site_source_id
        description: "Identifiant technique du site auquel la règle s'applique, résolu via la jointure avec site_dimension. Ne peut pas être NULL car le modèle filtre les règles sans site valide."
        tests:
          - not_null
      - name: metric_type
        description: "Type de métrique surveillée (temperature_range, humidity_ceiling, humidity_floor, temperature_stability, uptime_ratio, data_validity)."
        tests:
          - not_null
          - accepted_values:
              values: ['temperature_range', 'humidity_ceiling', 'humidity_floor', 'temperature_stability', 'uptime_ratio', 'data_validity']
      - name: min_allowed
        description: "Valeur minimale autorisée pour la métrique (NULL si pas de limite inférieure)."
      - name: max_allowed
        description: "Valeur maximale autorisée pour la métrique (NULL si pas de limite supérieure)."
      - name: criticality_level
        description: "Niveau de criticité de la règle (LOW, MEDIUM, HIGH)."
        tests:
          - not_null
          - accepted_values:
              values: ['LOW', 'MEDIUM', 'HIGH']
      - name: description
        description: "Description détaillée de la règle de conformité et de son impact métier."
        tests:
          - not_null
      - name: created_ts
        description: "Horodatage de création de la règle dans le système."
        tests:
          - not_null
      - name: updated_ts
        description: "Horodatage de dernière mise à jour de la règle."
        tests:
          - not_null

  - name: int_conformity_rules_scd2
    description: "Modèle intermédiaire implémentant SCD2 (Slowly Changing Dimension Type 2) pour les règles de conformité basé sur les snapshots dbt."
    columns:
      - name: rule_sk
        description: "Clé surrogate unique pour la dimension règle de conformité dans le DWH (générée automatiquement par le snapshot dbt)."
        tests:
          - not_null
          - unique
      - name: rule_id
        description: "Identifiant technique unique de la règle de conformité, provenant de la source brute."
        tests:
          - not_null
      - name: site_source_id
        description: "Identifiant technique du site auquel la règle s'applique, provenant de la source brute."
        tests:
          - not_null
      - name: metric_type
        description: "Type de métrique surveillée (temperature_range, humidity_ceiling, humidity_floor, temperature_stability, uptime_ratio, data_validity)."
        tests:
          - not_null
          - accepted_values:
              values: ['temperature_range', 'humidity_ceiling', 'humidity_floor', 'temperature_stability', 'uptime_ratio', 'data_validity']
      - name: min_allowed
        description: "Valeur minimale autorisée pour la métrique (NULL si pas de limite inférieure)."
      - name: max_allowed
        description: "Valeur maximale autorisée pour la métrique (NULL si pas de limite supérieure)."
      - name: criticality_level
        description: "Niveau de criticité de la règle (LOW, MEDIUM, HIGH)."
        tests:
          - not_null
          - accepted_values:
              values: ['LOW', 'MEDIUM', 'HIGH']
      - name: description
        description: "Description détaillée de la règle de conformité et de son impact métier."
        tests:
          - not_null
      - name: valid_from_ts
        description: "Indicateur SCD2: Horodatage indiquant à partir de quand cet enregistrement est valide (généré par le snapshot dbt)."
        tests:
          - not_null
      - name: valid_to_ts
        description: "Indicateur SCD2: Horodatage indiquant jusqu'à quand cet enregistrement est valide (NULL pour l'enregistrement actuel, généré par le snapshot dbt)."
      - name: is_current
        description: "Indicateur SCD2: Vrai si cet enregistrement est le plus récent pour cette règle (calculé à partir de valid_to_ts)."
        tests:
          - not_null

  - name: int_daily_site_env
    description: "Modèle intermédiaire pour l'agrégation des conditions environnementales par site et par jour. Consolide les métriques de tous les capteurs d'un site pour obtenir une vue d'ensemble des conditions environnementales et calculer les métriques dérivées nécessaires à l'évaluation de conformité."
    columns:
      - name: site_sk
        description: "Clé surrogate du site (référence vers dim_sites)."
        tests:
          - not_null
      
      - name: event_day_sk
        description: "Date de l'événement tronquée au jour."
        tests:
          - not_null
      
      - name: min_temperature_celsius_on_site
        description: "Température minimale moyenne mesurée sur le site pour la journée (moyenne des minimums par capteur)."
      
      - name: max_temperature_celsius_on_site
        description: "Température maximale moyenne mesurée sur le site pour la journée (moyenne des maximums par capteur)."
      
      - name: temperature_range_on_site
        description: "Plage de température du site calculée comme la différence entre max et min des températures moyennes."
      
      - name: min_humidity_percentage_on_site
        description: "Humidité minimale moyenne mesurée sur le site pour la journée (moyenne des minimums par capteur)."
      
      - name: max_humidity_percentage_on_site
        description: "Humidité maximale moyenne mesurée sur le site pour la journée (moyenne des maximums par capteur)."
      
      - name: humidity_range_on_site
        description: "Plage d'humidité du site calculée comme la différence entre max et min des humidités moyennes."
      
      - name: temperature_stability_on_site
        description: "Stabilité thermique du site (écart absolu entre températures max et min moyennes). Plus la valeur est faible, plus la température est stable."
      
      - name: uptime_ratio_on_site
        description: "Ratio de disponibilité des mesures sur le site (total_readings / 1440 lectures attendues par jour), plafonné à 1.0."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              inclusive: true
      
      - name: data_validity_on_site
        description: "Indicateur de validité des données (1.0 si toutes les conditions de plausibilité sont respectées, 0.0 sinon). Basé sur temp_min > 5°C, humidity_min > 10% et au moins 50 lectures."
        tests:
          - accepted_values:
              values: [0.0, 1.0]
      
      - name: total_readings_on_site
        description: "Nombre total de lectures de capteurs reçues sur le site pour la journée (somme de tous les capteurs)."
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - site_sk
            - event_day_sk
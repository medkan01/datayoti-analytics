models:
  - name: int_sites_scd2
    description: "Modèle intermédiaire implémentant SCD2 (Slowly Changing Dimension Type 2) pour les sites basé sur les snapshots dbt."
    columns:
      - name: site_sk
        description: "Clé surrogate unique pour la dimension site dans le DWH (générée automatiquement par le snapshot dbt)."
        tests:
          - not_null
          - unique
      - name: site_source_id
        description: "Identifiant technique unique du site, provenant de la source brute."
        tests:
          - not_null
      - name: site_ref
        description: "Référence métier du site (code court)."
        tests:
          - not_null
      - name: site_name
        description: "Nom du site."
      - name: site_description
        description: "Description détaillée du site."
      - name: valid_from_ts
        description: "Indicateur SCD2: Horodatage indiquant à partir de quand cet enregistrement est valide (généré par le snapshot dbt)."
        tests:
          - not_null
      - name: valid_to_ts
        description: "Indicateur SCD2: Horodatage indiquant jusqu'à quand cet enregistrement est valide (NULL pour l'enregistrement actuel, généré par le snapshot dbt)."
      - name: is_current
        description: "Indicateur SCD2: Vrai si cet enregistrement est le plus récent pour ce site (calculé à partir de valid_to_ts)."
        tests:
          - not_null

  - name: int_devices
    description: "Modèle intermédiaire pour les appareils avec des informations nettoyées et enrichies. Utilise LEFT JOIN avec sites pour préserver tous les devices."
    columns:
      - name: device_source_id
        description: "Identifiant technique unique de l'appareil, issu de la source brute."
        tests:
          - not_null
          - unique
      - name: device_mac_addr
        description: "Adresse MAC de l'appareil. Correspond à l'identifiant métier utilisé."
        tests:
          - not_null
          - unique
      - name: site_source_id
        description: "Identifiant technique du site auquel l'appareil est associé, provenant de la source brute. Peut être NULL si le site n'existe pas dans stg_sites."
        # Retiré not_null car LEFT JOIN peut donner NULL
      - name: created_ts
        description: "Horodatage de création de l'appareil dans le système."
        tests:
          - not_null
      - name: updated_ts
        description: "Horodatage de dernière mise à jour de l'appareil."
        tests:
          - not_null

  - name: int_devices_scd2
    description: "Modèle intermédiaire implémentant SCD2 (Slowly Changing Dimension Type 2) pour les appareils basé sur les snapshots dbt."
    columns:
      - name: device_sk
        description: "Clé surrogate unique pour la dimension device dans le DWH (générée automatiquement par le snapshot dbt)."
        tests:
          - not_null
          - unique
      - name: device_source_id
        description: "Identifiant technique unique de l'appareil, provenant de la source brute."
        tests:
          - not_null
      - name: device_mac_addr
        description: "Adresse MAC de l'appareil. Correspond à l'identifiant métier utilisé."
        tests:
          - not_null
      - name: site_source_id
        description: "Identifiant technique du site auquel l'appareil est associé, provenant de la source brute."
        tests:
          - not_null
      - name: valid_from_ts
        description: "Indicateur SCD2: Horodatage indiquant à partir de quand cet enregistrement est valide (généré par le snapshot dbt)."
        tests:
          - not_null
      - name: valid_to_ts
        description: "Indicateur SCD2: Horodatage indiquant jusqu'à quand cet enregistrement est valide (NULL pour l'enregistrement actuel, généré par le snapshot dbt)."
      - name: is_current
        description: "Indicateur SCD2: Vrai si cet enregistrement est le plus récent pour cet appareil (calculé à partir de valid_to_ts)."
        tests:
          - not_null
  
  - name: int_hourly_sensor_health
    description: "Modèle intermédiaire pour les métriques de santé des capteurs agrégées par heure."
    columns:
      - name: device_id
        description: "Identifiant unique de l'appareil."
        tests:
          - not_null
      - name: event_hour_ts
        description: "Horodatage tronqué à l'heure pour l'agrégation des événements."
        tests:
          - not_null
      - name: avg_rssi_dbm
        description: "Moyenne du signal RSSI en dBm pour l'heure."
      - name: min_rssi_dbm
        description: "Valeur minimale du signal RSSI en dBm pour l'heure."
      - name: max_rssi_dbm
        description: "Valeur maximale du signal RSSI en dBm pour l'heure."
      - name: avg_free_heap_bytes
        description: "Moyenne de la mémoire heap libre en octets pour l'heure."
      - name: min_free_heap_bytes
        description: "Valeur minimale de la mémoire heap libre en octets pour l'heure."
      - name: max_free_heap_bytes
        description: "Valeur maximale de la mémoire heap libre en octets pour l'heure."
      - name: avg_min_heap_bytes
        description: "Moyenne du minimum de mémoire heap atteint en octets pour l'heure."
      - name: min_min_heap_bytes
        description: "Valeur minimale du minimum de mémoire heap atteint en octets pour l'heure."
      - name: max_min_heap_bytes
        description: "Valeur maximale du minimum de mémoire heap atteint en octets pour l'heure."
      - name: avg_uptime_secs
        description: "Moyenne du temps de fonctionnement en secondes pour l'heure."
      - name: min_uptime_secs
        description: "Valeur minimale du temps de fonctionnement en secondes pour l'heure."
      - name: max_uptime_secs
        description: "Valeur maximale du temps de fonctionnement en secondes pour l'heure."
      - name: first_reception_hour_ts
        description: "Premier horodatage de réception tronqué à l'heure."
      - name: last_reception_hour_ts
        description: "Dernier horodatage de réception tronqué à l'heure."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - device_id
            - event_hour_ts

  - name: int_hourly_sensor_reading
    description: "Modèle intermédiaire pour les lectures de capteurs (température et humidité) agrégées par heure."
    columns:
      - name: device_id
        description: "Identifiant unique de l'appareil."
        tests:
          - not_null
      - name: event_hour_ts
        description: "Horodatage tronqué à l'heure pour l'agrégation des événements."
        tests:
          - not_null
      - name: avg_temperature_celsius
        description: "Température moyenne en degrés Celsius pour l'heure."
      - name: min_temperature_celsius
        description: "Température minimale en degrés Celsius pour l'heure."
      - name: max_temperature_celsius
        description: "Température maximale en degrés Celsius pour l'heure."
      - name: avg_humidity_percentage
        description: "Humidité moyenne en pourcentage pour l'heure."
      - name: min_humidity_percentage
        description: "Humidité minimale en pourcentage pour l'heure."
      - name: max_humidity_percentage
        description: "Humidité maximale en pourcentage pour l'heure."
      - name: first_reception_hour_ts
        description: "Premier horodatage de réception tronqué à l'heure (métrique de qualité d'ingestion)."
      - name: last_reception_hour_ts
        description: "Dernier horodatage de réception tronqué à l'heure (métrique de qualité d'ingestion)."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - device_id
            - event_hour_ts

  - name: int_daily_sensor_reading
    description: "Modèle intermédiaire pour les lectures de capteurs (température et humidité) agrégées par jour. Utilise des jointures temporelles SCD2 avec les dimensions devices et sites."
    columns:
      - name: device_sk
        description: "Clé surrogate de l'appareil (référence vers dim_devices)."
        tests:
          - not_null
      - name: site_sk
        description: "Clé surrogate du site (référence vers dim_sites)."
        tests:
          - not_null
      - name: event_day_ts
        description: "Date de l'événement tronquée au jour."
        tests:
          - not_null
      - name: avg_temperature_celsius
        description: "Température moyenne en degrés Celsius pour la journée."
      - name: min_temperature_celsius
        description: "Température minimale en degrés Celsius pour la journée."
      - name: max_temperature_celsius
        description: "Température maximale en degrés Celsius pour la journée."
      - name: avg_humidity_percentage
        description: "Humidité moyenne en pourcentage pour la journée."
      - name: min_humidity_percentage
        description: "Humidité minimale en pourcentage pour la journée."
      - name: max_humidity_percentage
        description: "Humidité maximale en pourcentage pour la journée."
      - name: total_readings
        description: "Nombre total de lectures de capteurs pour la journée."
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - device_sk
            - site_sk
            - event_day_ts

  - name: int_daily_sensor_health
    description: "Modèle intermédiaire pour les métriques de santé des appareils agrégées par jour. Utilise des jointures temporelles SCD2 avec les dimensions devices et sites."
    columns:
      - name: device_sk
        description: "Clé surrogate de l'appareil (référence vers dim_devices)."
        tests:
          - not_null
      - name: site_sk
        description: "Clé surrogate du site (référence vers dim_sites)."
        tests:
          - not_null
      - name: event_day_ts
        description: "Date de l'événement tronquée au jour pour l'agrégation."
        tests:
          - not_null
      - name: avg_rssi_dbm
        description: "Moyenne du signal RSSI en dBm pour la journée."
      - name: min_rssi_dbm
        description: "Valeur minimale du signal RSSI en dBm pour la journée."
      - name: max_rssi_dbm
        description: "Valeur maximale du signal RSSI en dBm pour la journée."
      - name: avg_free_heap_bytes
        description: "Moyenne de la mémoire heap libre en octets pour la journée."
      - name: min_free_heap_bytes
        description: "Valeur minimale de la mémoire heap libre en octets pour la journée."
      - name: max_free_heap_bytes
        description: "Valeur maximale de la mémoire heap libre en octets pour la journée."
      - name: avg_min_heap_bytes
        description: "Moyenne du minimum de mémoire heap atteint en octets pour la journée."
      - name: min_min_heap_bytes
        description: "Valeur minimale du minimum de mémoire heap atteint en octets pour la journée."
      - name: max_min_heap_bytes
        description: "Valeur maximale du minimum de mémoire heap atteint en octets pour la journée."
      - name: avg_uptime_secs
        description: "Moyenne du temps de fonctionnement en secondes pour la journée."
      - name: min_uptime_secs
        description: "Valeur minimale du temps de fonctionnement en secondes pour la journée."
      - name: max_uptime_secs
        description: "Valeur maximale du temps de fonctionnement en secondes pour la journée."
      - name: ntp_sync_count
        description: "Nombre de heartbeats avec synchronisation NTP active pour la journée."
      - name: total_heartbeats
        description: "Nombre total de heartbeats reçus pour la journée."
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - device_sk
            - site_sk
            - event_day_ts